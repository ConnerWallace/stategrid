@page "/"
@using BlazorApp1.Components.DB
@using Microsoft.Data.Sqlite
@rendermode InteractiveServer


@if (Categories == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <CascadingValue Value=@this IsFixed=true
    >
        <Popup @ref="popupRef" IsVisibleChanged="@(args=> onSubmit(args))" />
    </CascadingValue>
    <div>
        <table style="width:75%; display:inline-block" class="table">
            <thead>
                <tr>
                    <th style="width:25%" class="invisible"></th>

                    <Category CategoryTitle="@Categories[0]" />
                    <Category CategoryTitle="@Categories[1]" />
                    <Category CategoryTitle="@Categories[2]" />
                </tr>
            </thead>
            <tbody>
                <tr>
                    <Category CategoryTitle="@Categories[3]"/>
                    <td style="width:25%;height:25%;" @onclick="() => setValue(0)"> <Answer stateParam="@answers[0]" /></td>
                    <td style="width:25%" @onclick="() => setValue(1)"> <Answer stateParam="@answers[1]" /></td>
                    <td style="width:25%" @onclick="() => setValue(2)"> <Answer stateParam="@answers[2]" /></td>

                </tr>
                <tr>
                    <Category CategoryTitle="@Categories[4]" />
                    <td style="width:25%" @onclick="() => setValue(3)"> <Answer stateParam="@answers[3]" /></td>
                    <td style="width:25%" @onclick="() => setValue(4)"> <Answer stateParam="@answers[4]" /></td>
                    <td style="width:25%" @onclick="() => setValue(5)"> <Answer stateParam="@answers[5]" /></td>
                </tr>
                <tr>
                    <Category CategoryTitle="@Categories[5]" />
                    <td style="width:25%" @onclick="() => setValue(6)"> <Answer stateParam="@answers[6]" /></td>
                    <td style="width:25%" @onclick="() => setValue(7)"> <Answer stateParam="@answers[7]" /></td>
                    <td style="width:25%" @onclick="() => setValue(8)"> <Answer stateParam="@answers[8]" /></td>
                </tr>
            </tbody>
        </table>
        <div style=" display:inline-block">
            <p>game number: @gameNumber</p>
            <p>score: @score</p>
            <p>guesses left: @guesses</p>

        </div>
    </div>
}

@code {
    private Popup popupRef;
    private string[] Categories = new[] { "starts with m", "smaller than 1000 sq miles", "starts with A", "capital is largest city", "avg temp > 45", "Has a coast (including the great lakes)" };
    private List<string> answers = new List<string> { "", "", "", "", "", "", "", "", "" };
    private List<List<string>> categoriesCorrectAnswers = new List<List<string>>();
    private int score = 900;
    private int guesses = 10;
    private int gameNumber = 1;

    private TestDbContext dB = new TestDbContext();

    public Home()
    {
        this.popupRef = new Popup();
        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[0].AddRange(dB.nameStartsWith("M"));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[1].AddRange(dB.areaSmallerThan(1000));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[2].AddRange(dB.nameStartsWith("A"));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[3].AddRange(dB.query("capital = bigCity"));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[4].AddRange(dB.query("averageTemp > 45"));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[5].AddRange(dB.query("seaCoast != 'None' OR greatLakes = 1"));
    }

    private void setValue(int index)
    {
        this.popupRef.Show(index, index.ToString());
    }

    private void onSubmit((int index, string input) a)
    {
        var (x, y) = xyFromIndex(a.index);
        var answer = a.input.ToLowerInvariant();

        if (categoriesCorrectAnswers[x].Contains(answer)
        && categoriesCorrectAnswers[y].Contains(answer)
        && !answers.Contains(answer)
        && guesses > 0
        )
        {
            answers[a.index] = a.input;

            //dB.getScore(answer, gameNumber, a.index);
            //dB.updateScore(answer, gameNumber, a.index);
        }
        guesses -= 1;
        if (guesses < 0) guesses = 0;

    }

    private (int, int) xyFromIndex(int index)
    {
        switch (index)
        {
            case 0: return (0, 3);
            case 1: return (1, 3);
            case 2: return (2, 3);

            case 3: return (0, 4);
            case 4: return (1, 4);
            case 5: return (2, 4);

            case 6: return (0, 5);
            case 7: return (1, 5);
            case 8: return (2, 5);
            default: return (0, 0);
        }
    }
}
