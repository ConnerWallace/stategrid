@page "/"
@using BlazorApp1.Components.DB
@using Microsoft.Data.Sqlite
@using BlazorApp1.Components.UserData
@rendermode InteractiveServer

@if (Categories == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <CascadingValue Value=@this IsFixed=true>
        <Popup @ref="popupRef" states="allStates" IsVisibleChanged="@(args=> onSubmit(args))" />
    </CascadingValue>
    <Descriptions @ref="descRef"> 

    </Descriptions>

    <div class="top-container">
        <div class="three-column-layout">
            <div class="sidebar"></div>
            <div class="board">
                <div class="panel">
                    <div class="row">
                        <div class="invisible"></div>
                        <div class="prompt column-prompt" @onclick="() => showDes()">
                            <CategoryContainer CategoryTitle="@Categories[0].Name" />
                        </div>
                        <div class="prompt column-prompt" @onclick="() => showDes()">
                            <CategoryContainer CategoryTitle="@Categories[1].Name" />
                        </div>
                        <div class="prompt column-prompt" @onclick="() => showDes()">
                            <CategoryContainer CategoryTitle="@Categories[2].Name" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="prompt row-prompt" @onclick="() => showDes()">
                            <CategoryContainer CategoryTitle="@Categories[3].Name" />
                        </div>
                        <div class="box" @onclick="() => setValue(0)"> <AnswerContainer stateParam="@answers[0]" rarity="@rarities[0]" /></div>
                        <div class="box" @onclick="() => setValue(1)"> <AnswerContainer stateParam="@answers[1]" rarity="@rarities[1]" /></div>
                        <div class="box" @onclick="() => setValue(2)"> <AnswerContainer stateParam="@answers[2]" rarity="@rarities[2]" /></div>

                    </div>
                    <div class="row">
                        <div class="prompt row-prompt" @onclick="() => showDes()">
                            <CategoryContainer CategoryTitle="@Categories[4].Name" />
                            </div>
                        <div class="box" @onclick="() => setValue(3)"> <AnswerContainer stateParam="@answers[3]" rarity="@rarities[3]" /></div>
                        <div class="box" @onclick="() => setValue(4)"> <AnswerContainer stateParam="@answers[4]" rarity="@rarities[4]" /></div>
                        <div class="box" @onclick="() => setValue(5)"> <AnswerContainer stateParam="@answers[5]" rarity="@rarities[5]" /></div>
                    </div>
                        <div class="row">
                        <div class="prompt row-prompt" @onclick="() => showDes()">
                            <CategoryContainer CategoryTitle="@Categories[5].Name" />
                        </div>
                        <div class="box" @onclick="() => setValue(6)"> <AnswerContainer stateParam="@answers[6]" rarity="@rarities[6]" /></div>
                        <div class="box" @onclick="() => setValue(7)"> <AnswerContainer stateParam="@answers[7]" rarity="@rarities[7]" /></div>
                        <div class="box" @onclick="() => setValue(8)"> <AnswerContainer stateParam="@answers[8]" rarity="@rarities[8]" /></div>
                    </div>
                </div>

                <div class="column">
                    <div class="card column-item">
                        game number: @gameNumber
                    </div>
                    <div class="card column-item">
                        Score: @score
                    </div>
                    <div class="card column-item"> <ClipboardButton Text="@forClipboard"></ClipboardButton> </div>
                </div>
            </div>
            <div class="sidebar"></div>
        </div>
    </div>
}

@code {
    private Popup popupRef;
    private Descriptions descRef;
    private Category[] Categories = new Category[6];
    private string[] answers = new string[9];
    private double[] rarities = new double[] { 100, 100 ,100,  100, 100, 100,  100, 100, 100};
    private List<List<string>> categoriesCorrectAnswers = new List<List<string>>();
    private int gameNumber = (int)(DateTime.Now - DateTime.Parse("11/13/2025")).TotalDays; //Loses a day for some reason
    private List<string> allStates = new List<string>();
    private bool win = false;
    private StateinfoContext dB = new StateinfoContext();
    private UserDataContext userDataContext = new UserDataContext();
    private TestDbContext dbButBad = new TestDbContext();
    private double score = 900;
    private string forClipboard = "";

    public Home()
    {
        Game todaysGame = dB.Games.Single(b => b.Id == gameNumber);
        Categories[0] = dB.Categories.Single(c => c.Id == todaysGame.Cat1);
        Categories[1] = dB.Categories.Single(c => c.Id == todaysGame.Cat2);
        Categories[2] = dB.Categories.Single(c => c.Id == todaysGame.Cat3);
        Categories[3] = dB.Categories.Single(c => c.Id == todaysGame.Cat4);
        Categories[4] = dB.Categories.Single(c => c.Id == todaysGame.Cat5);
        Categories[5] = dB.Categories.Single(c => c.Id == todaysGame.Cat6);

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[0].AddRange(dbButBad.query(Categories[0].Clause));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[1].AddRange(dbButBad.query(Categories[1].Clause));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[2].AddRange(dbButBad.query(Categories[2].Clause));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[3].AddRange(dbButBad.query(Categories[3].Clause));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[4].AddRange(dbButBad.query(Categories[4].Clause));

        categoriesCorrectAnswers.Add(new List<string>());
        categoriesCorrectAnswers[5].AddRange(dbButBad.query(Categories[5].Clause));

        allStates.AddRange(dbButBad.query("Select name from States"));

        emojify();
    }

    private async Task setValue(int index)
    {
        var (x, y) = xyFromIndex(index);
        popupRef.Show(index, Categories[x].Name, Categories[y].Name);

    }

    private void onSubmit((int index, string input) a)
    {


        var (x, y) = xyFromIndex(a.index);
        var answer = a.input;

        if (categoriesCorrectAnswers[x].Contains(answer, StringComparer.OrdinalIgnoreCase)
        && categoriesCorrectAnswers[y].Contains(answer, StringComparer.OrdinalIgnoreCase)
        && !answers.Contains(answer)
        )
        {
            var listOfSubmittedAnswers = userDataContext.Answers.Where(c => c.Game == gameNumber && c.AnswerSlot == a.index).ToList();

            var currentAnswer = listOfSubmittedAnswers.Find(a => a.StateName.Equals(answer, StringComparison.InvariantCultureIgnoreCase));
            int sum = 0;
            foreach (Answer answer1 in listOfSubmittedAnswers)
            {
                sum += answer1.NumberOfGuesses.GetValueOrDefault(0);
            }
            if (currentAnswer != null)
            {
                rarities[a.index] = currentAnswer.NumberOfGuesses.GetValueOrDefault(0) / (double)sum * 100.0;
                currentAnswer.NumberOfGuesses += 1;

            } else
            {
                currentAnswer = new Answer
                    {
                        Game = gameNumber,
                        StateName = answer,
                        AnswerSlot = a.index,
                        NumberOfGuesses = 1
                    };
                rarities[a.index] = 0;
                userDataContext.Answers.Add(currentAnswer);
            }
            _ = userDataContext.SaveChangesAsync();


            score = rarities.Sum();
            answers[a.index] = categoriesCorrectAnswers[x].FirstOrDefault(t => string.Equals(answer,t, StringComparison.InvariantCultureIgnoreCase))!;
        }

        emojify();
    }

    public void showDes()
    {
        descRef.show();
        popupRef.Close();
    }


    public void emojify()
    {
        var text = scoreToEmoji(0) + scoreToEmoji(1) + scoreToEmoji(2) + "\r\n" +
                scoreToEmoji(3) + scoreToEmoji(4) + scoreToEmoji(5) + "\r\n" +
                scoreToEmoji(6) + scoreToEmoji(7) + scoreToEmoji(8) + "\r\n" +
                "score: " + score + " | game #" + gameNumber + "\r\n" +
                "http://stategriddle.com";

        forClipboard = text;
    }
    private string scoreToEmoji(int index)
    {
        if (answers[index] == null)
            return "❌";
        var score = rarities[index];

        switch (score)
        {
            case 0:
                return "🦅";
            case < 5:
                return "🟥";
            case < 10:
                return "🟪";
            case < 20:
                return "🟦";
            case < 30:
                return "🟨";
            default:
                return "🟩";
        }
    }

    private (int, int) xyFromIndex(int index)
    {
        switch (index)
        {
            case 0: return (0, 3);
            case 1: return (1, 3);
            case 2: return (2, 3);

            case 3: return (0, 4);
            case 4: return (1, 4);
            case 5: return (2, 4);

            case 6: return (0, 5);
            case 7: return (1, 5);
            case 8: return (2, 5);
            default: return (0, 0);
        }
    }
}
